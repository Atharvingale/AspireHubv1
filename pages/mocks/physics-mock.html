<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mock Test - Live Page</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    
    <!-- MathJax Configuration -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)']],
                displayMath: [['\\[', '\\]']]
            },
            svg: {
                fontCache: 'global'
            },
            startup: {
                pageReady: () => {
                    return MathJax.startup.defaultPageReady().then(() => {
                        console.log('MathJax initial typesetting complete');
                    });
                }
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" id="MathJax-script" async></script>

    <style>
        :root {
            --primary-color: #4a90e2;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f1c40f;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 90%;
            max-width: 1200px;
            background: var(--primary-color);
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .container {
            display: flex;
            width: 90%;
            max-width: 1200px;
            background: white;
            border-radius: 8px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            gap: 20px;
        }

        .left-panel, .right-panel {
            width: 25%;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .middle-panel {
            width: 50%;
            text-align: center;
            padding: 0 20px;
        }

        .question-panel, .answer-area {
            margin: 20px 0;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
            gap: 15px;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            flex: 1;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        }

        .question-number {
            margin: 15px 0;
            color: #7f8c8d;
            font-weight: 500;
        }

        /* Radio button styling */
        .answer-option {
            display: block;
            margin: 10px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            background: white;
        }

        .answer-option:hover {
            background-color: #f8f9fa;
            border-color: var(--primary-color);
        }

        .answer-option input[type="radio"] {
            margin-right: 10px;
        }

        .answer-option.selected {
            background-color: #e3f2fd;
            border-color: var(--primary-color);
        }

        /* Navigation buttons */
        .nav-btn {
            padding: 8px;
            margin: 2px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            min-width: 30px;
            transition: all 0.3s ease;
        }

        .nav-btn.current {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .nav-btn.answered {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        .nav-btn:hover {
            background: #f0f0f0;
            border-color: var(--primary-color);
        }

        .nav-btn.current:hover {
            background: var(--primary-color);
        }

        .nav-btn.answered:hover {
            background: var(--success-color);
            opacity: 0.9;
        }

        .nav-btn.review {
            background: var(--warning-color);
            color: white;
            border-color: var(--warning-color);
        }

        .nav-btn.review:hover {
            background: var(--warning-color);
            opacity: 0.9;
        }

        .nav-btn.review.current {
            background: linear-gradient(45deg, var(--warning-color) 50%, var(--primary-color) 50%);
        }

        .nav-btn.review.answered {
            background: linear-gradient(45deg, var(--warning-color) 50%, var(--success-color) 50%);
        }

        /* Add legend for question status */
        .question-status-legend {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            background: white;
            font-size: 0.9em;
        }

        .status-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }

        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 3px;
            margin-right: 8px;
        }

        .status-current {
            background: var(--primary-color);
        }

        .status-answered {
            background: var(--success-color);
        }

        .status-unanswered {
            background: white;
            border: 1px solid #ddd;
        }

        #question-nav {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            margin: 10px 0;
        }

        .nav-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding: 10px 0;
        }

        /* Debug info styles */
        #debug-info {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        #debug-info p {
            margin: 5px 0;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        /* Responsive design */
        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }

            .left-panel, .middle-panel, .right-panel {
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .buttons {
                flex-direction: column;
            }

            #question-nav {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Loading animation */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .loading::after {
            content: "Loading...";
            font-size: 1.2em;
            color: var(--primary-color);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        /* Add styles for submit section */
        .submit-section {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .submit-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .submit-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
        }

        .submit-summary {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .submit-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .btn-submit {
            background: var(--success-color);
            color: white;
        }

        .btn-review {
            background: var(--warning-color);
            color: white;
        }

        /* Add styles for evaluation page */
        .evaluation-section {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f4f4f9;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .evaluation-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .score-section {
            text-align: center;
            padding: 20px;
            margin-bottom: 30px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            font-weight: bold;
            color: white;
            background: var(--primary-color);
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .analysis-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }

        .analysis-item h4 {
            margin: 0 0 10px 0;
            color: #666;
        }

        .analysis-item .value {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary-color);
        }

        .question-review {
            margin-top: 30px;
        }

        .question-item {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .question-item.correct {
            border-left: 4px solid var(--success-color);
        }

        .question-item.incorrect {
            border-left: 4px solid var(--danger-color);
        }

        .answer-status {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .answer-status div {
            flex: 1;
        }

        .status-label {
            font-weight: bold;
            color: #666;
        }

        .correct-answer {
            color: var(--success-color);
        }

        .wrong-answer {
            color: var(--danger-color);
        }

        .btn-finish {
            display: block;
            width: 200px;
            margin: 30px auto;
            padding: 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>Chemistry Mock Test</div>
        <div id="timer">⏳ Time Remaining: <span id="time-left">60:00</span></div>
        <div><a href="./index.html#mocks" style="color: white; text-decoration: none;">↩ Take Another Test</a></div>
    </div>

    <div class="container">
        <div class="left-panel">
            <h3>📋 Instructions</h3>
            <ul>
                <li>All questions are mandatory</li>
                <li>No negative marking</li>
                <li>Timer cannot be paused</li>
                <li>Full-screen mode recommended</li>
            </ul>
        </div>

        <div class="middle-panel">
            <div class="question-number">Question <span id="current-question-number">1</span> of <span id="total-questions">0</span></div>
            <div class="question-panel">
                <h3 id="question-text">Loading questions...</h3>
            </div>
            <div class="answer-area">
                <form id="quiz-form"></form>
            </div>
            <div class="buttons">
                <button class="btn-secondary" onclick="prevQuestion()">← Previous</button>
                <button class="btn-warning" onclick="toggleReview()" id="review-btn" style="background: var(--warning-color);">Mark for Review</button>
                <button class="btn-primary" onclick="nextQuestion()">Next →</button>
            </div>
        </div>

        <div class="right-panel">
            <h3>Question Navigation</h3>
            <div class="nav-container">
                <div id="question-nav"></div>
                <div class="nav-controls">
                    <button class="nav-arrow" id="prev-page" onclick="prevNavPage()">←</button>
                    <span id="nav-page-info">Page 1</span>
                    <button class="nav-arrow" id="next-page" onclick="nextNavPage()">→</button>
                </div>
            </div>
            <div class="question-status-legend">
                <div class="status-item">
                    <div class="status-indicator status-current"></div>
                    <span>Current Question</span>
                </div>
                <div class="status-item">
                    <div class="status-indicator status-answered"></div>
                    <span>Attempted</span>
                </div>
                <div class="status-item">
                    <div class="status-indicator status-unanswered"></div>
                    <span>Not Attempted</span>
                </div>
                <div class="status-item">
                    <div class="status-indicator" style="background: var(--warning-color);"></div>
                    <span>Marked for Review</span>
                </div>
            </div>
        </div>
    </div>

    <div class="submit-section" id="submit-section">
        <div class="submit-container">
            <div class="submit-header">
                <h2>Submit Test</h2>
            </div>
            <div class="submit-summary">
                <h3>Test Summary</h3>
                <p>Total Questions: <span id="summary-total">0</span></p>
                <p>Questions Attempted: <span id="summary-attempted">0</span></p>
                <p>Questions Remaining: <span id="summary-remaining">0</span></p>
            </div>
            <div class="submit-actions">
                <button class="btn-review" onclick="closeSubmitPage()">Review Answers</button>
                <button class="btn-submit" onclick="submitTest()">Submit Test</button>
            </div>
        </div>
    </div>

    <div class="evaluation-section" id="evaluation-section">
        <div class="evaluation-container">
            <h2 style="text-align: center; margin-bottom: 30px;">Test Evaluation</h2>
            
            <div class="score-section">
                <div class="score-circle">
                    <span id="score-percentage">0%</span>
                </div>
                <h3>Your Score: <span id="score-fraction">0/0</span></h3>
            </div>

            <div class="analysis-grid">
                <div class="analysis-item">
                    <h4>Total Questions</h4>
                    <div class="value" id="total-questions-value">0</div>
                </div>
                <div class="analysis-item">
                    <h4>Correct Answers</h4>
                    <div class="value" id="correct-answers-value">0</div>
                </div>
                <div class="analysis-item">
                    <h4>Incorrect Answers</h4>
                    <div class="value" id="incorrect-answers-value">0</div>
                </div>
                <div class="analysis-item">
                    <h4>Accuracy</h4>
                    <div class="value" id="accuracy-value">0%</div>
                </div>
            </div>

            <div class="question-review">
                <h3>Detailed Review</h3>
                <div id="question-review-list">
                    <!-- Questions will be inserted here -->
                </div>
            </div>

            <button class="btn-finish" onclick="finishTest()">Return to Home</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCISFm8eH78b9tX_M9KnKjq8m6SM5yu8uc",
            authDomain: "mock-32c0f.firebaseapp.com",
            projectId: "mock-32c0f",
            storageBucket: "mock-32c0f.appspot.com",
            messagingSenderId: "515196484575",
            appId: "1:515196484575:web:88ef3a4c205f915060e26a",
            measurementId: "G-12BGXR042L"
        };

        // Initialize Firebase with error handling
        try {
            console.log("Initializing Firebase...");
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            console.log("Firebase initialized successfully");
            window.db = db;
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            document.getElementById("question-text").textContent = "Error initializing Firebase: " + error.message;
        }

        // Global variables
        let currentQuestionIndex = 0;
        let currentNavPage = 0;
        const questionsPerPage = 20;
        window.questions = [];
        window.selectedAnswers = {};
        window.reviewedQuestions = new Set(); // Track questions marked for review
        let timeLeft = 60 * 60; // 60 minutes in seconds
        let timerInterval;
        const testId = 'chemistry_test'; // Unique identifier for this test

        // Add visibility change detection
        let warningDiv = null;
        let tabSwitchCount = 0;
        const MAX_TAB_SWITCHES = 3;

        // Modified fullscreen change handler with immediate submission
        function handleFullscreenChange() {
            if (!document.fullscreenElement && 
                !document.webkitFullscreenElement && 
                !document.mozFullscreenElement && 
                !document.msFullscreenElement && 
                window.testStarted) {
                
                // Show warning message
                const warningDiv = document.createElement('div');
                warningDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(231, 76, 60, 0.95);
                    color: white;
                    padding: 20px;
                    border-radius: 8px;
                    text-align: center;
                    z-index: 10000;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                `;
                warningDiv.innerHTML = `
                    <h3 style="margin: 0 0 10px 0;">⚠️ Test Terminated</h3>
                    <p style="margin: 0 0 15px 0;">You have exited fullscreen mode.</p>
                    <p style="margin: 0 0 15px 0;">Your test will be submitted immediately.</p>
                `;
                
                document.body.appendChild(warningDiv);
                
                // Clear timer and submit test immediately
                clearInterval(timerInterval);
                setTimeout(() => {
                    warningDiv.remove();
                    submitTest(true);
                }, 2000);
            }
        }

        // Modified visibility change handler with immediate submission
        function handleVisibilityChange() {
            if (document.hidden && window.testStarted) {
                // Show warning message
                const warningDiv = document.createElement('div');
                warningDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(231, 76, 60, 0.95);
                    color: white;
                    padding: 20px;
                    border-radius: 8px;
                    text-align: center;
                    z-index: 10000;
                    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                `;
                warningDiv.innerHTML = `
                    <h3 style="margin: 0 0 10px 0;">⚠️ Test Terminated</h3>
                    <p style="margin: 0 0 15px 0;">Tab switching is not allowed.</p>
                    <p style="margin: 0 0 15px 0;">Your test will be submitted immediately.</p>
                `;
                
                document.body.appendChild(warningDiv);
                
                // Clear timer and submit test immediately
                clearInterval(timerInterval);
                setTimeout(() => {
                    warningDiv.remove();
                    submitTest(true);
                }, 2000);
            }
        }

        // Function to save test progress
        async function saveTestProgress() {
            const testProgress = {
                selectedAnswers: window.selectedAnswers,
                currentQuestionIndex: currentQuestionIndex,
                timeLeft: timeLeft,
                reviewedQuestions: Array.from(window.reviewedQuestions),
                timestamp: new Date().toISOString()
            };

            try {
                // Always try localStorage first
                localStorage.setItem('testProgress_' + testId, JSON.stringify(testProgress));
                console.log("Test progress saved to localStorage successfully");

                // Then try Firebase if available
                if (window.db) {
                    try {
                        await setDoc(doc(db, "test_progress", testId), testProgress);
                        console.log("Test progress saved to Firebase successfully");
                    } catch (error) {
                        console.warn("Firebase save failed, using localStorage only:", error);
                    }
                }
            } catch (error) {
                console.error("Failed to save progress:", error);
            }
        }

        // Function to load test progress
        async function loadTestProgress() {
            try {
                // Try localStorage first
                const localProgress = localStorage.getItem('testProgress_' + testId);
                if (localProgress) {
                    const progress = JSON.parse(localProgress);
                    if (loadProgressData(progress)) {
                        console.log("Progress loaded from localStorage");
                        return true;
                    }
                }

                // Then try Firebase if available
                if (window.db) {
                    try {
                        const progressDoc = await getDoc(doc(db, "test_progress", testId));
                        if (progressDoc.exists()) {
                            const progress = progressDoc.data();
                            if (loadProgressData(progress)) {
                                console.log("Progress loaded from Firebase");
                                return true;
                            }
                        }
                    } catch (error) {
                        console.warn("Firebase load failed:", error);
                    }
                }
            } catch (error) {
                console.warn("Failed to load progress:", error);
            }

            return false;
        }

        // Helper function to load progress data
        function loadProgressData(progress) {
            const lastTimestamp = new Date(progress.timestamp);
            const currentTime = new Date();
            const timeDifference = Math.floor((currentTime - lastTimestamp) / 1000);
            
            // Only restore progress if within the last 24 hours
            if (timeDifference < 24 * 60 * 60) {
                window.selectedAnswers = progress.selectedAnswers || {};
                currentQuestionIndex = progress.currentQuestionIndex || 0;
                timeLeft = Math.max(0, progress.timeLeft - timeDifference);
                window.reviewedQuestions = new Set(progress.reviewedQuestions || []);
                return true;
            }
            return false;
        }

        // Function to toggle review status
        window.toggleReview = function() {
            const questionId = window.questions[currentQuestionIndex].id;
            if (window.reviewedQuestions.has(questionId)) {
                window.reviewedQuestions.delete(questionId);
            } else {
                window.reviewedQuestions.add(questionId);
            }
            updateQuestionNavigation();
            updateReviewButton();
            saveTestProgress();
        };

        // Function to update review button state
        function updateReviewButton() {
            const reviewBtn = document.getElementById('review-btn');
            const questionId = window.questions[currentQuestionIndex].id;
            if (window.reviewedQuestions.has(questionId)) {
                reviewBtn.textContent = 'Remove Review Mark';
                reviewBtn.style.background = '#95a5a6';
            } else {
                reviewBtn.textContent = 'Mark for Review';
                reviewBtn.style.background = 'var(--warning-color)';
            }
        }

        // Modified fetchQuestions function
        async function fetchQuestions() {
            try {
                console.log("Starting to fetch questions...");
                const querySnapshot = await getDocs(collection(db, "physics"));
                
                if (!querySnapshot || querySnapshot.empty) {
                    throw new Error("No questions found in database");
                }

                // Get all questions and validate them before adding
                const allQuestions = querySnapshot.docs.map(doc => {
                    const data = doc.data();
                    // Validate question data
                    if (!data.question_text || !data.options || !data.correct_option) {
                        console.warn(`Skipping invalid question with ID ${doc.id}:`, data);
                        return null;
                    }
                    return {
                        id: doc.id,
                        ...data
                    };
                }).filter(q => q !== null); // Remove any invalid questions

                if (allQuestions.length === 0) {
                    throw new Error("No valid questions found in database");
                }

                console.log(`Found ${allQuestions.length} valid questions`);

               

                // Take only the first 50 questions
                window.questions = allQuestions.slice(0, 50);

                console.log(`Selected ${window.questions.length} questions for the test`);
                document.getElementById("total-questions").textContent = window.questions.length;
                
                // Try to load saved progress
                const progressLoaded = await loadTestProgress();
                
                if (!progressLoaded) {
                    // If no progress loaded, start fresh
                    console.log("No previous progress found, starting fresh");
                    currentQuestionIndex = 0;
                    await displayQuestion(0);
                } else {
                    console.log("Loaded previous progress, resuming from question", currentQuestionIndex + 1);
                    await displayQuestion(currentQuestionIndex);
                }
                
                updateQuestionNavigation();
                startTimer(); // Start the timer when questions are loaded
                
            } catch (error) {
                console.error("Error in fetchQuestions:", error);
                document.getElementById("question-text").innerHTML = `
                    <div style="color: red; text-align: left; padding: 20px;">
                        <h3>Error Loading Questions</h3>
                        <p>Details: ${error.message}</p>
                        <p>Please try:</p>
                        <ul>
                            <li>Checking your internet connection</li>
                            <li>Refreshing the page</li>
                            <li>Verifying Firebase configuration</li>
                        </ul>
                    </div>`;
            }
        }

        // Modified displayQuestion function with enhanced error handling
        window.displayQuestion = async function(index) {
            try {
                console.log(`Attempting to display question ${index + 1}`);
                
                if (!window.questions || !Array.isArray(window.questions)) {
                    throw new Error("Questions array is not properly initialized");
                }

                const question = window.questions[index];
                if (!question) {
                    throw new Error(`Question not found at index: ${index}`);
                }

                // Validate question data
                if (!question.question_text) {
                    throw new Error(`Question ${index + 1} is missing question text`);
                }
                if (!question.options || Object.keys(question.options).length === 0) {
                    throw new Error(`Question ${index + 1} is missing options`);
                }

                // Update the display
                const questionTextElement = document.getElementById("question-text");
                questionTextElement.innerHTML = question.question_text;
                document.getElementById("current-question-number").textContent = index + 1;

                const form = document.getElementById("quiz-form");
                form.innerHTML = "";

                // Create options
                Object.entries(question.options).forEach(([key, value]) => {
                    if (!value) {
                        console.warn(`Empty option value for key ${key} in question ${index + 1}`);
                        return;
                    }

                    const label = document.createElement("label");
                    label.className = "answer-option";
                    if (window.selectedAnswers[question.id] === key) {
                        label.classList.add("selected");
                    }
                    
                    const input = document.createElement("input");
                    input.type = "radio";
                    input.name = "answer";
                    input.value = key;
                    input.checked = window.selectedAnswers[question.id] === key;
                    
                    input.addEventListener('change', () => {
                        window.selectedAnswers[question.id] = key;
                        updateQuestionNavigation();
                        saveTestProgress();
                    });
                    
                    label.appendChild(input);
                    label.appendChild(document.createTextNode(` ${key}: ${value}`));
                    form.appendChild(label);
                });

                updateReviewButton();

                // Handle MathJax rendering with retries
                if (typeof MathJax !== 'undefined') {
                    let retryCount = 0;
                    const maxRetries = 3;
                    
                    const tryTypeset = async () => {
                        try {
                            await MathJax.typesetPromise([questionTextElement]);
                            console.log(`MathJax rendering successful for question ${index + 1}`);
                        } catch (error) {
                            console.warn(`MathJax rendering attempt ${retryCount + 1} failed:`, error);
                            if (retryCount < maxRetries) {
                                retryCount++;
                                setTimeout(tryTypeset, 1000);
                            }
                        }
                    };
                    
                    await tryTypeset();
                }

                console.log(`Successfully displayed question ${index + 1}`);
                saveTestProgress();

            } catch (error) {
                console.error("Error in displayQuestion:", error);
                document.getElementById("question-text").innerHTML = `
                    <div style="color: red; text-align: left; padding: 20px;">
                        <h3>Error Displaying Question ${index + 1}</h3>
                        <p>Details: ${error.message}</p>
                        <p>Please try refreshing the page. If the error persists, contact support.</p>
                    </div>`;
            }
        };

        // Navigation functions
        window.prevQuestion = function() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion(currentQuestionIndex);
                updateQuestionNavigation();
            }
        };

        window.nextQuestion = function() {
            if (currentQuestionIndex < window.questions.length - 1) {
                currentQuestionIndex++;
                displayQuestion(currentQuestionIndex);
                updateQuestionNavigation();
            }
        };

        window.prevNavPage = function() {
            if (currentNavPage > 0) {
                currentNavPage--;
                updateQuestionNavigation();
            }
        };

        window.nextNavPage = function() {
            const totalPages = Math.ceil(window.questions.length / questionsPerPage);
            if (currentNavPage < totalPages - 1) {
                currentNavPage++;
                updateQuestionNavigation();
            }
        };

        // Update question navigation
        function updateQuestionNavigation() {
            const nav = document.getElementById("question-nav");
            nav.innerHTML = "";
            
            const startIdx = currentNavPage * questionsPerPage;
            const endIdx = Math.min(startIdx + questionsPerPage, window.questions.length);
            
            for (let i = startIdx; i < endIdx; i++) {
                const btn = document.createElement("button");
                btn.textContent = i + 1;
                btn.className = "nav-btn";
                const questionId = window.questions[i].id;
                
                if (i === currentQuestionIndex) {
                    btn.classList.add("current");
                }
                if (window.selectedAnswers[questionId]) {
                    btn.classList.add("answered");
                }
                if (window.reviewedQuestions.has(questionId)) {
                    btn.classList.add("review");
                }
                
                btn.onclick = () => {
                    currentQuestionIndex = i;
                    displayQuestion(i);
                    updateQuestionNavigation();
                };
                
                nav.appendChild(btn);
            }

            const totalPages = Math.ceil(window.questions.length / questionsPerPage);
            document.getElementById("nav-page-info").textContent = `Page ${currentNavPage + 1} of ${totalPages}`;
            
            document.getElementById("prev-page").disabled = currentNavPage === 0;
            document.getElementById("next-page").disabled = currentNavPage >= totalPages - 1;

            const totalQuestions = window.questions.length;
            const attemptedQuestions = Object.keys(window.selectedAnswers).length;
            
            // Show submit button in the buttons div if all questions are attempted
            const buttonsDiv = document.querySelector('.buttons');
            const existingSubmitBtn = document.querySelector('.btn-submit-test');
            
            if (attemptedQuestions === totalQuestions && !existingSubmitBtn) {
                const submitBtn = document.createElement('button');
                submitBtn.className = 'btn-primary btn-submit-test';
                submitBtn.textContent = 'Submit Test';
                submitBtn.onclick = showSubmitPage;
                buttonsDiv.appendChild(submitBtn);
            } else if (existingSubmitBtn && attemptedQuestions < totalQuestions) {
                existingSubmitBtn.remove();
            }
        }

        // Initialize with strict fullscreen warning
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Document loaded, starting initialization...");
            
            const startPrompt = document.createElement('div');
            startPrompt.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
            `;
            
            const promptContent = document.createElement('div');
            promptContent.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 8px;
                text-align: center;
                max-width: 500px;
            `;
            
            promptContent.innerHTML = `
                <h2 style="color: #e74c3c;">⚠️ Important Test Rules</h2>
                <div style="text-align: left; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <p style="color: #e74c3c; font-weight: bold; margin-bottom: 15px;">Warning: Strict Test Environment</p>
                    <ul style="margin-left: 20px; line-height: 1.6;">
                        <li><strong>Fullscreen Mode:</strong> The test must be taken in fullscreen mode</li>
                        <li><strong>No Tab Switching:</strong> Changing browser tabs is not allowed</li>
                        <li><strong>Immediate Submission:</strong> Violating these rules will result in immediate test submission</li>
                        <li><strong>No Second Chances:</strong> The test cannot be retaken if submitted due to violations</li>
                    </ul>
                </div>
                <p style="margin: 20px 0; color: #666;">Please ensure you are ready to take the test without interruptions.</p>
                <button id="start-test" style="
                    background: #2ecc71;
                    color: white;
                    border: none;
                    padding: 12px 30px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 16px;
                    font-weight: bold;
                ">I Understand, Start Test</button>
            `;
            
            startPrompt.appendChild(promptContent);
            document.body.appendChild(startPrompt);
            
            document.getElementById('start-test').addEventListener('click', () => {
                startPrompt.remove();
                startTest();
            });
        });

        function startTest() {
            window.testStarted = true;
            
            // Request fullscreen mode
            requestFullscreen().then(() => {
                fetchQuestions();
                startTimer();
            }).catch(error => {
                console.error('Failed to enter fullscreen:', error);
                alert('Fullscreen mode is required. Please allow fullscreen mode and try again.');
                window.location.href = './index.html#mocks';
            });

            // Add all event listeners
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
            document.addEventListener('mozfullscreenchange', handleFullscreenChange);
            document.addEventListener('MSFullscreenChange', handleFullscreenChange);
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            // Prevent context menu
            document.addEventListener('contextmenu', (e) => {
                if (window.testStarted) {
                    e.preventDefault();
                    return false;
                }
            });

            // Prevent keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (window.testStarted) {
                    if (e.altKey || e.ctrlKey || e.shiftKey || 
                        e.key === 'F11' || e.key === 'Escape' || 
                        e.key === 'Tab' || e.key === 'F4') {
                        e.preventDefault();
                        e.stopPropagation();
                        return false;
                    }
                }
            }, true);

            // Prevent tab switching
            window.addEventListener('blur', () => {
                if (window.testStarted) {
                    handleVisibilityChange();
                }
            });
        }

        // Modified requestFullscreen function
        async function requestFullscreen() {
            const element = document.documentElement;
            try {
                if (element.requestFullscreen) {
                    await element.requestFullscreen();
                } else if (element.webkitRequestFullscreen) {
                    await element.webkitRequestFullscreen();
                } else if (element.msRequestFullscreen) {
                    await element.msRequestFullscreen();
                } else if (element.mozRequestFullScreen) {
                    await element.mozRequestFullScreen();
                }
            } catch (error) {
                console.warn('Fullscreen request failed:', error);
                throw error;
            }
        }

        // Add these functions after the existing script content
        window.showSubmitPage = function() {
            const submitSection = document.getElementById('submit-section');
            const totalQuestions = window.questions.length;
            const attemptedQuestions = Object.keys(window.selectedAnswers).length;
            
            document.getElementById('summary-total').textContent = totalQuestions;
            document.getElementById('summary-attempted').textContent = attemptedQuestions;
            document.getElementById('summary-remaining').textContent = totalQuestions - attemptedQuestions;
            
            submitSection.style.display = 'flex';
        };

        window.closeSubmitPage = function() {
            document.getElementById('submit-section').style.display = 'none';
        };

        // Modify the submitTest function to handle Firebase errors
        window.submitTest = async function(isAutoSubmit = false) {
            if (!isAutoSubmit) {
                const confirmSubmit = confirm("Are you sure you want to submit the test? This action cannot be undone.");
                if (!confirmSubmit) return;
            }

            // Remove event listeners
            document.removeEventListener('visibilitychange', handleVisibilityChange);
            window.removeEventListener('blur', handleVisibilityChange);
            
            clearInterval(timerInterval);

            try {
                // Calculate results
                let correctAnswers = 0;
                const results = window.questions.map(question => {
                    const userAnswer = window.selectedAnswers[question.id] || 'not_attempted';
                    const isCorrect = userAnswer === question.correct_option;
                    if (isCorrect) correctAnswers++;
                    return {
                        question: question.question_text,
                        userAnswer,
                        correctAnswer: question.correct_option,
                        isCorrect,
                        options: question.options
                    };
                });

                const finalResults = {
                    timestamp: new Date().toISOString(),
                    totalQuestions: window.questions.length,
                    correctAnswers,
                    selectedAnswers: window.selectedAnswers,
                    completed: true
                };

                // Save results to localStorage first
                localStorage.setItem('testResults_' + testId, JSON.stringify(finalResults));

                // Try to save to Firebase if available
                if (window.db) {
                    try {
                        await setDoc(doc(db, "test_results", testId), finalResults);
                        await setDoc(doc(db, "test_progress", testId), { completed: true });
                    } catch (error) {
                        console.warn("Firebase save failed, using localStorage only:", error);
                    }
                }

                // Update UI with results
                const totalQuestions = window.questions.length;
                const scorePercentage = Math.round((correctAnswers / totalQuestions) * 100);
                
                document.getElementById('score-percentage').textContent = `${scorePercentage}%`;
                document.getElementById('score-fraction').textContent = `${correctAnswers}/${totalQuestions}`;
                document.getElementById('total-questions-value').textContent = totalQuestions;
                document.getElementById('correct-answers-value').textContent = correctAnswers;
                document.getElementById('incorrect-answers-value').textContent = totalQuestions - correctAnswers;
                document.getElementById('accuracy-value').textContent = `${scorePercentage}%`;

                // Generate detailed review
                const reviewList = document.getElementById('question-review-list');
                reviewList.innerHTML = results.map((result, index) => `
                    <div class="question-item ${result.isCorrect ? 'correct' : 'incorrect'}">
                        <h4>Question ${index + 1}</h4>
                        <div class="question-text">${result.question}</div>
                        <div class="answer-status">
                            <div>
                                <div class="status-label">Your Answer:</div>
                                <div class="${result.isCorrect ? 'correct-answer' : 'wrong-answer'}">
                                    ${result.userAnswer === 'not_attempted' ? 'Not Attempted' : result.options[result.userAnswer]}
                                </div>
                            </div>
                            ${!result.isCorrect ? `
                                <div>
                                    <div class="status-label">Correct Answer:</div>
                                    <div class="correct-answer">
                                        ${result.options[result.correctAnswer]}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('');

                // Hide submit section and show evaluation
                document.getElementById('submit-section').style.display = 'none';
                document.getElementById('evaluation-section').style.display = 'block';

                // Render LaTeX in the evaluation page
                if (typeof MathJax !== 'undefined') {
                    try {
                        await MathJax.typesetPromise([document.getElementById('question-review-list')]);
                    } catch (error) {
                        console.error('Error rendering LaTeX in evaluation:', error);
                    }
                }

            } catch (error) {
                console.error("Error evaluating test:", error);
                alert("There was an error saving your results to the server, but your results are saved locally and displayed below.");
            }
        };

        window.finishTest = function() {
            window.location.href = './index.html#mocks';
        };

        // Add these timer-related functions after the existing script content
        function startTimer() {
            timerInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            
            document.getElementById('time-left').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                alert("Time's up! Your test will be submitted automatically.");
                submitTest(true); // Pass true to indicate auto-submission
            } else {
                timeLeft--;
            }
        }

        // Add beforeunload event to warn about leaving the page
        window.addEventListener('beforeunload', (e) => {
            if (window.testStarted && timeLeft > 0) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>